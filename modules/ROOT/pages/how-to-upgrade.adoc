[[connector-upgrade]]
= Connector Upgrade

include::partial$third-party.adoc[]

== 5.0.x => 5.1 migration guide

When upgrading to the new 5.1 Neo4j Kafka Connector be aware that many of the configuration properties have been changed and updated.
Please take special care to ensure the new configuration logically matches the previous configuration.

Firstly, read over xref:whats-new.adoc[] to familiarise yourself with the recent changes.

For generic Kafka Connect plugin upgrade documentation see: https://docs.confluent.io/platform/current/connect/upgrade.html[Upgrade]

IMPORTANT: Please complete the following steps in full for each connector (source or sink) currently registered.

=== Confluent Platform

This guide follows the connector xref:quickstart-docker.adoc[] docker execution method.

.Steps
. Go to Confluent Control Center instance at `http://localhost:9021/clusters` and find the registered connector.
Once found delete the source/sink connector.

. Look at the logs for the `connect` container (`docker-compose logs -f connect`).
As part of the connector deletion/shutdown a migrated configuration will be printed to the logs.
Example:

[source,shell]
----
include::example$docker-data/how-to-upgrade.migrated-config.log[]
----

. Create a new `JSON` file `(source/sink)5_1.neo4j.json` and copy the migrated example config to this file along with the connector name.
.. The configuration should contain a `name` property and the migrated configuration should be nested in the `config` key.

include::partial$how-to-upgrade-validate-config.adoc[]

. Download the new connector version following the xref:installation.adoc[] guide and remove the original 5.0.x connector version.
.. The new plugin should be copied into the `./plugins/` folder created during the docker setup

. Restart the Kafka Connect Worker by running `docker-compose restart connect`.
This allows the new plugin to picked up by the Kafka Connect platform reading from the `./plugins/` folder.

. Using the new configuration continue following the xref:quickstart-docker.adoc[] guide to deploy the plugin to Kafka Connect.
.. Make sure to enable Change Data Capture and update the configuration with CDC related properties.

. Once the connector is up and running, validate it is successfully running.

=== Confluent Cloud

This guide follows the connector xref:quickstart-confluent-cloud.adoc[] execution method.

.Steps

. Access the Confluent Cloud cluster associated with the relevant connectors.
. Open the `Connectors` section and find the relevant source or sink connector for upgrading
. Go to the `Settings` section, click the pause button for the connector.
+
image::migration/confluent-cloud-pause.png[]
. Go to the `Logs` section, locate or search for a log message starting with `The migrated settings for 5.1 version of Neo4j`.
+
image::migration/confluent-cloud-config-log.png[width=800]

. Save this printed configuration locally

include::partial$how-to-upgrade-validate-config.adoc[]

. Follow the xref:quickstart-confluent-cloud.adoc[] tutorial to upload the new 5.1 Connector plugin
. Create a Source or Sink instance
. Using the new migrated configuration copy it into the Custom Configuration JSON section.
.. Verify this configuration is correct
. Continue with the steps in the Quickstart guide
. Once the connector is up and running, validate it is successfully running.

=== Troubleshooting

[qanda]
Failing to connect to Neo4j instance?::
The configuration migration login does not migrate the password of the Neo4j instance or other sensitive properties.
These options need to be re-entered. Once updated re-run the connector.

Unexpected error::
Looking at the logs of Kafka Connect may reveal other errors in configuration.
. Confluent Cloud
.. Logs are accessible through the `Logs` section on the Connector run page
. Confluent Platform
.. Logs are accessible through docker commands `docker-compose logs -f connect`